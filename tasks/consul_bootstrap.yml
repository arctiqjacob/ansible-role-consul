---
- name: waiting for Consul cluster to come up before bootstrapping
  pause:
    seconds: 10

- name: bootstrapping Consul cluster
  uri:
    url: http://{{ inventory_hostname }}:8500/v1/acl/bootstrap
    method: PUT
    status_code: 200
  register: bootstrap_token
  run_once: yes

- name: applying Consul agent policy
  uri:
    url: http://{{ inventory_hostname }}:8500/v1/acl/policy
    body: '{{ lookup("file","agent-policy.json") }}'
    body_format: json
    method: PUT
    headers:
      X-Consul-Token: '{{ bootstrap_token.json.SecretID }}'
    status_code: 200
  run_once: yes

- name: applying Consul agent token
  uri:
    url: http://{{ inventory_hostname }}:8500/v1/acl/token
    body: '{"Description": "Consul Agent Token", "Policies": [{ "Name": "agent-token" }]}'
    body_format: json
    method: PUT
    headers:
      X-Consul-Token: '{{ bootstrap_token.json.SecretID }}'
    status_code: 200
  register: consul_agent_token
  run_once: yes

- name: adding Consul agent token to all Consul nodes
  blockinfile:
    path: '{{ consul_config_file }}'
    insertafter: 'down_policy'
    block: |
      tokens {
        "agent" = "{{ consul_agent_token.json.SecretID }}"
      }

- name: outputting Consul boostrap token
  debug:
    msg: 'Consul Bootstrap token: {{ bootstrap_token.json.SecretID }}'
  run_once: yes

- name: outputting Consul agent token
  debug:
    msg: 'Consul Bootstrap token: {{ consul_agent_token.json.SecretID }}'
  run_once: yes